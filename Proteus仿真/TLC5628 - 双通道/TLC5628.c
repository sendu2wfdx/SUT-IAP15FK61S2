#include <REGX51.H>
#include <Delay.h>
#include <TLC5628.H>

sbit CLK 	= P3^0; //串行时钟,下降沿有效
sbit DAT 	= P3^1; //串行数据
sbit LOAD = P3^2; //串行数据加载,下降沿有效
sbit LDAC = P3^3; //DAC更新锁存控制,下降沿有效

extern unsigned char flag;

//正弦表，128点x2
code unsigned char SinTab1[] =
{
		128,134,140,147,153,159,165,171,177,182,188,193,199,204,209,213,
		218,222,226,230,234,237,240,243,245,248,250,251,253,254,254,255,
		255,255,254,254,253,251,250,248,245,243,240,237,234,230,226,222,
		218,213,209,204,199,193,188,182,177,171,165,159,153,147,140,134,
		128,122,116,109,103, 97, 91, 85, 79, 74, 68, 63, 57, 52, 47, 43,
		 38, 34, 30, 26, 22, 19, 16, 13, 11,  8,  6,  5,  3,  2,  2,  1,
			1,  1,  2,  2,  3,  5,  6,  8, 11, 13, 16, 19, 22, 26, 30, 34,
		 38, 43, 47, 52, 57, 63, 68, 74, 79, 85, 91, 97,103,109,116,122,
		128,134,140,147,153,159,165,171,177,182,188,193,199,204,209,213,
		218,222,226,230,234,237,240,243,245,248,250,251,253,254,254,255,
		255,255,254,254,253,251,250,248,245,243,240,237,234,230,226,222,
		218,213,209,204,199,193,188,182,177,171,165,159,153,147,140,134,
		128,122,116,109,103, 97, 91, 85, 79, 74, 68, 63, 57, 52, 47, 43,
		 38, 34, 30, 26, 22, 19, 16, 13, 11,  8,  6,  5,  3,  2,  2,  1,
			1,  1,  2,  2,  3,  5,  6,  8, 11, 13, 16, 19, 22, 26, 30, 34,
		 38, 43, 47, 52, 57, 63, 68, 74, 79, 85, 91, 97,103,109,116,122
};

//正弦表，256点x1
code unsigned char SinTab2[] =
{
		128,131,134,137,140,144,147,150,153,156,159,162,165,168,171,174,
		177,179,182,185,188,191,193,196,199,201,204,206,209,211,213,216,
		218,220,222,224,226,228,230,232,234,235,237,239,240,241,243,244,
		245,246,248,249,250,250,251,252,253,253,254,254,254,255,255,255,
		255,255,255,255,254,254,254,253,253,252,251,250,250,249,248,246,
		245,244,243,241,240,239,237,235,234,232,230,228,226,224,222,220,
		218,216,213,211,209,206,204,201,199,196,193,191,188,185,182,179,
		177,174,171,168,165,162,159,156,153,150,147,144,140,137,134,131,
		128,125,122,119,116,112,109,106,103,100,97,94,91,88,85,82,
		79,77,74,71,68,65,63,60,57,55,52,50,47,45,43,40,
		38,36,34,32,30,28,26,24,22,21,19,17,16,15,13,12,
		11,10,8,7,6,6,5,4,3,3,2,2,2,1,1,1,
		1,1,1,1,2,2,2,3,3,4,5,6,6,7,8,10,
		11,12,13,15,16,17,19,21,22,24,26,28,30,32,34,36,
		38,40,43,45,47,50,52,55,57,60,63,65,68,71,74,77,
		79,82,85,88,91,94,97,100,103,106,109,112,116,119,122,125
};

/*TCL5628 驱动函数*/
void TCL5628_Write(unsigned char addr, bit rng, unsigned char dat)
{
		unsigned char n;

		// 发送通道地址
		n = 3;
		do
		{
				DAT = (bit)(addr & 0x04);
				addr <<= 1;
				CLK = 0;
				CLK = 1;
		}while(--n != 0);

		//发送RNG位
		DAT = rng;
		CLK = 0;
		CLK = 1;

		//发送8位DAC数据
		n = 8;
		do
		{
				DAT = (bit)(dat & 0x80);
				dat <<= 1;
				CLK = 0;
				CLK = 1;
		}while(--n != 0);
		
		//加载数据
		LOAD = 0;
		LOAD = 1;
		LDAC = 0;
		LDAC = 1;
}

/*初始化TLC5628*/
void Init_TLC5628()
{
        DAT = 1;
        CLK = 1;
        LDAC = 1;
        LOAD = 1;
}

/*DA输出函数*/
void SinWave()
{
		/*根据曲线光滑来选取采样点*/
		unsigned char n;
		while(1)
		{
				for(n = 0; n < 256; n++)
				{
						TCL5628_Write(0,0,SinTab1[n]);
						TCL5628_Write(1,0,SinTab2[n]);
				}
		}
}
